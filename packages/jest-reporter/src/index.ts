import type { Config, Reporter, ReporterOnStartOptions, Test, TestResult, AggregatedResult, TestContext } from "@jest/reporters"; import * as path from "node:path"; export interface QanaryReporterOptions { apiUrl?: string; apiKey?: string; project?: string; runId?: string; branch?: string; commit?: string; } class QanaryJestReporter implements Reporter { private options: QanaryReporterOptions; private tests: any[] = []; constructor(globalConfig: Config.GlobalConfig, options: QanaryReporterOptions = {}) { this.options = { apiUrl: process.env.QANARY_API_URL || "http://localhost:3000/api/runs/push", apiKey: process.env.QANARY_API_KEY, project: process.env.QANARY_PROJECT || "unknown-project", runId: process.env.QANARY_RUN_ID, branch: process.env.QANARY_BRANCH || "main", commit: process.env.QANARY_COMMIT || "unknown", ...options, }; } onRunStart(results: AggregatedResult, options: ReporterOnStartOptions) {} onTestResult(test: Test, testResult: TestResult, aggregatedResults: AggregatedResult) { const file = path.basename(test.path); testResult.testResults.forEach((result) => { const testCase: any = { id: `${test.path}-${result.fullName}`, title: result.title, suite: result.ancestorTitles.join(" > ") || "Root", file: file, parentSuite: "API", source: "jest", outcome: this.mapStatus(result.status), durationMs: result.duration || 0, steps: [], attachments: [], }; if (result.failureMessages.length > 0) { testCase.error = { message: result.failureMessages[0], stack: result.failureMessages.join("\n"), }; } this.tests.push(testCase); }); } async onRunComplete(contexts: Set<TestContext>, results: AggregatedResult) { const payload = { id: this.options.runId, repo: this.options.project, branch: this.options.branch, commit: this.options.commit, tests: this.tests, }; console.log(`[Qanary] Sending ${this.tests.length} test results to ${this.options.apiUrl}...`); try { const response = await fetch(this.options.apiUrl!, { method: "POST", headers: { "Content-Type": "application/json", Authorization: this.options.apiKey ? `Bearer ${this.options.apiKey}` : "", }, body: JSON.stringify(payload), }); if (!response.ok) { const text = await response.text(); console.error(`[Qanary] Failed to push results: ${response.status} ${text}`); return; } const data: any = await response.json(); console.log(`[Qanary] Results pushed successfully. Run ID: ${data.runId}`); } catch (error) { console.error("[Qanary] Error pushing results:", error); } } onTestStart(test: Test) {} getLastError() {} private mapStatus(status: string): string { switch (status) { case "passed": return "passed"; case "failed": return "failed"; case "skipped": case "pending": case "todo": case "disabled": return "skipped"; default: return "skipped"; } } } export default QanaryJestReporter;
